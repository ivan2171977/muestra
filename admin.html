<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel del Vendedor — Colegio Albania</title>
<link rel="icon" type="image/png" href="img/favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{ --brand:#0b3a74; --accent:#f4c20d; }
  body{ background:#f5f7fb; }
  .navbar{ background:var(--brand) !important; }
  .navbar .nav-link, .navbar .navbar-brand{ color:#fff !important; }
  .navbar .nav-link:hover{ color:var(--accent) !important; }
  .logo-img{ height:40px; width:auto; }
  .status-badge{ font-size:12px; }

  .inv-thumb{ width:48px; height:48px; object-fit:cover; border:1px solid #ddd; border-radius:6px; }
  .inv-controls .form-select, .inv-controls .form-control{ min-width: 160px; }
  .inv-controls{ gap: .5rem; }
</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="catalogo_coalba.html#top">
      <img src="img/LogoColegioAlbania-1024x358.png" class="logo-img" alt="Colegio Albania">
    </a>
    <ul class="navbar-nav ms-auto align-items-center gap-2">
      <li class="nav-item"><a class="nav-link" href="catalogo_coalba.html#top">Inicio</a></li>
      <li class="nav-item"><a class="nav-link" href="#" id="logoutSeller">Salir</a></li>
    </ul>
  </div>
</nav>

<main class="container py-4">
  <h1 class="h4 mb-3">Panel del Vendedor</h1>
  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">Pedidos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="reservas-tab" data-bs-toggle="tab" data-bs-target="#reservas" type="button" role="tab">Reservas</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="inventario-tab" data-bs-toggle="tab" data-bs-target="#inventario" type="button" role="tab">Inventario</button>
    <button class="nav-link" id="registrar-tab" data-bs-toggle="tab" data-bs-target="#registrar" type="button" role="tab">Registrar/Actualizar</button>
    <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#reportes" type="button" role="tab">Reportes</button>
    </li>
  </ul>

  <div class="tab-content border border-top-0 bg-white p-3 shadow-sm">
    <div class="tab-pane fade show active" id="orders" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead><tr><th>ID</th><th>Fecha</th><th>Items</th><th class="text-end">Total</th><th>Estado</th><th></th></tr></thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>
    </div>
    <div class="tab-pane fade" id="reservas" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead><tr><th>ID</th><th>Fecha</th><th>Producto</th><th>Cant.</th><th>Talla</th><th>Precio</th><th>Estado</th><th></th></tr></thead>
          <tbody id="reservasBody"></tbody>
        </table>
      </div>
    </div>
    <div class="tab-pane fade" id="inventario" role="tabpanel">
      <div class="alert alert-info small">Este inventario controla <b>visibilidad</b> y <b>precio</b> de los ítems del catálogo (solo en este navegador).</div>
<div class="inv-controls d-flex flex-wrap align-items-end mb-3">
  <div>
    <label class="form-label mb-1">Sección</label>
    <select id="fSeccion" class="form-select form-select-sm">
      <option value="todos" selected>Todos</option>
      <option value="ropa">Ropa</option>
      <option value="libros">Libros</option>
    </select>
  </div>
  <div>
    <label class="form-label mb-1">Género</label>
    <select id="fGenero" class="form-select form-select-sm">
      <option value="todos" selected>Todos</option>
      <option value="chica">Chica</option>
      <option value="chico">Chico</option>
    </select>
  </div>
  <div>
    <label class="form-label mb-1">Subcategoría</label>
    <select id="fSub" class="form-select form-select-sm">
      <option value="todos" selected>Todos</option>
      <option value="sudaderas">Sudaderas</option>
      <option value="camisas">Camisas</option>
      <option value="correas">Correas</option>
      <option value="zapatos">Zapatos</option>
    </select>
  </div>
  <div class="ms-auto" style="min-width:220px;">
    <label class="form-label mb-1">Buscar</label>
    <input id="fSearch" type="search" class="form-control form-control-sm" placeholder="Nombre del producto...">
  </div>
</div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr><th style="width:60px;">Img</th><th>Producto</th><th>Sección</th><th>Género</th><th>Subcat</th><th style="width:140px;">Precio (COP)</th><th style="width:120px;">Visible</th></tr>
          </thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>
      <div class="text-end">
        <button class="btn btn-primary btn-sm" id="saveInvBtn">Guardar cambios</button>
        <button class="btn btn-outline-secondary btn-sm" id="resetInvBtn">Reset</button>
      </div>
    </div>
  
    <div class="tab-pane fade" id="registrar" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card p-3 shadow-sm">
            <h2 class="h6 mb-3">Crear / Actualizar ítem</h2>
            <div class="row g-2">
              <div class="col-12"><input id="rNombre" class="form-control" placeholder="Nombre del producto"></div>
              <div class="col-6">
                <label class="form-label mb-1">Sección</label>
                <select id="rSeccion" class="form-select">
                  <option value="ropa">Ropa</option>
                  <option value="libros">Libros</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label mb-1">Género</label>
                <select id="rGenero" class="form-select">
                  <option value="chica">Chica</option>
                  <option value="chico">Chico</option>
                  <option value="todos">Todos</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label mb-1">Subcategoría</label>
                <select id="rSubcat" class="form-select">
                  <option value="sudaderas">Sudaderas</option>
                  <option value="camisas">Camisas</option>
                  <option value="correas">Correas</option>
                  <option value="zapatos">Zapatos</option>
                  <option value="todos">Todos</option>
                </select>
              </div>
              <div class="col-6">
                <input id="rCantidad" type="text" inputmode="numeric" pattern="[0-9]*" class="form-control" placeholder="Cantidad (stock)">
              </div>
              <div class="col-12">
                <label class="form-label mb-1">Imagen</label>
                <input id="rImg" type="file" accept="image/*" class="form-control">
                <div class="form-text">Se ajusta automáticamente (miniatura).</div>
              </div>
              <div class="col-6">
                <input id="rPrecio" type="text" inputmode="numeric" pattern="[0-9]*" class="form-control" placeholder="Precio (solo admin)">
              </div>
              <div class="col-6 d-grid">
                <button id="btnGuardarItem" class="btn btn-primary">Guardar ítem</button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card p-3 shadow-sm">
            <h2 class="h6 mb-3">Previsualización</h2>
            <div id="rPreview" class="border rounded p-3 text-muted">Cargando previsualización…</div>
          </div>
        </div>
      </div>
    </div>


    <div class="tab-pane fade" id="reportes" role="tabpanel">
      <div class="card p-3 shadow-sm">
        <div class="row g-3 align-items-end">
          <div class="col-sm-3">
            <label class="form-label mb-1">Desde</label>
            <input type="date" id="repDesde" class="form-control">
          </div>
          <div class="col-sm-3">
            <label class="form-label mb-1">Hasta</label>
            <input type="date" id="repHasta" class="form-control">
          </div>
          <div class="col-sm-3">
            <button id="repGenerar" class="btn btn-primary w-100">Generar</button>
          </div>
          <div class="col-sm-3">
            <button id="repExport" class="btn btn-outline-secondary w-100">Exportar CSV</button>
          </div>
        </div>
        <hr>
        <div id="repResumen" class="row g-3"></div>
        <div class="table-responsive mt-3">
          <table class="table table-striped align-middle">
            <thead><tr><th>Pedido</th><th>Fecha</th><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead>
            <tbody id="repBody"></tbody>
          </table>
        </div>
      </div>
    </div>

</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="common.js"></script>
<script>
  // Guard: exigir login vendedor
  if (!(isSeller() && isLoggedIn())){
    alert('Acceso restringido a vendedores.');
    window.location.href = 'catalogo_coalba.html';
  }

  document.getElementById('logoutSeller').addEventListener('click', (e)=>{
    e.preventDefault();
    setLoggedIn(false); setRole('buyer');
    window.location.href = 'catalogo_coalba.html';
  });

  // ----- Pedidos
  function renderOrders(){
    const body = document.getElementById('ordersBody');
    const list = getOrders();
    if (!list.length){ body.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Sin pedidos.</td></tr>'; return; }
    body.innerHTML = list.map(o => `
      <tr>
        <td>${o.id}</td>
        <td>${new Date(o.date).toLocaleString()}</td>
        <td>
          ${o.items.map(i => `<div class="small">${i.name} x${i.qty} (${i.talla||'—'})</div>`).join('')}
        </td>
        <td class="text-end">${formatPrice(o.total)} COP</td>
        <td><span class="badge bg-warning text-dark status-badge">${o.status}</span></td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-success" onclick="updateOrder('${o.id}','completado')">Completar</button>
            <button class="btn btn-outline-danger" onclick="updateOrder('${o.id}','cancelado')">Cancelar</button>
          </div>
        </td>
      </tr>
    `).join('');
  }
  function updateOrder(id, status){
    const list = getOrders();
    const i = list.findIndex(x=>x.id===id);
    if (i>=0){ list[i].status = status; saveOrders(list); renderOrders(); }
  }

  // ----- Reservas
  function renderReservas(){
    const body = document.getElementById('reservasBody');
    const list = getReservations();
    if (!list.length){ body.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Sin reservas.</td></tr>'; return; }
    body.innerHTML = list.map(r => `
      <tr>
        <td>${r.id}</td>
        <td>${new Date(r.date).toLocaleString()}</td>
        <td>${r.name}</td>
        <td>${r.qty}</td>
        <td>${r.talla||'—'}</td>
        <td>${formatPrice(r.price)} COP</td>
        <td><span class="badge bg-warning text-dark status-badge">${r.status}</span></td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-success" onclick="updateReserva('${r.id}','aprobada')">Aprobar</button>
            <button class="btn btn-outline-danger" onclick="updateReserva('${r.id}','rechazada')">Rechazar</button>
          </div>
        </td>
      </tr>
    `).join('');
  }
  function updateReserva(id, status){
    const list = getReservations();
    const i = list.findIndex(x=>x.id===id);
    if (i>=0){ list[i].status = status; saveReservations(list); renderReservas(); }
  }

  // ----- Inventario (overrides y visibilidad)
  const BASE_ITEMS = [{"id": 1, "name": "Correa Chica 01", "section": "ropa", "genero": "chica", "subcat": "correas", "price": 77098, "img": "item_001.png"}, {"id": 2, "name": "Sudadera Chica 02", "section": "ropa", "genero": "chica", "subcat": "sudaderas", "price": 133696, "img": "item_002.png"}, {"id": 3, "name": "Sudadera Chico 03", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 48905, "img": "item_003.png"}, {"id": 4, "name": "Camisa Chica 04", "section": "ropa", "genero": "chica", "subcat": "camisas", "price": 111237, "img": "item_004.png"}, {"id": 5, "name": "Zapatos Chica 05", "section": "ropa", "genero": "chica", "subcat": "zapatos", "price": 73893, "img": "item_005.png"}, {"id": 6, "name": "Libro 06", "section": "libros", "genero": "todos", "subcat": "todos", "price": 68618, "img": "item_006.png"}, {"id": 7, "name": "Libro 07", "section": "libros", "genero": "todos", "subcat": "todos", "price": 83046, "img": "item_007.png"}, {"id": 8, "name": "Zapatos Chica 08", "section": "ropa", "genero": "chica", "subcat": "zapatos", "price": 89597, "img": "item_008.png"}, {"id": 9, "name": "Libro 09", "section": "libros", "genero": "todos", "subcat": "todos", "price": 40189, "img": "item_009.png"}, {"id": 10, "name": "Sudadera Chico 10", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 57156, "img": "item_010.png"}, {"id": 11, "name": "Libro 11", "section": "libros", "genero": "todos", "subcat": "todos", "price": 36338, "img": "item_011.png"}, {"id": 12, "name": "Libro 12", "section": "libros", "genero": "todos", "subcat": "todos", "price": 85541, "img": "item_012.png"}, {"id": 13, "name": "Libro 13", "section": "libros", "genero": "todos", "subcat": "todos", "price": 69565, "img": "item_013.png"}, {"id": 14, "name": "Libro 14", "section": "libros", "genero": "todos", "subcat": "todos", "price": 82895, "img": "item_014.png"}, {"id": 15, "name": "Sudadera Chico 15", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 94615, "img": "item_015.png"}, {"id": 16, "name": "Correa Chico 16", "section": "ropa", "genero": "chico", "subcat": "correas", "price": 120674, "img": "item_016.png"}, {"id": 17, "name": "Sudadera Chica 17", "section": "ropa", "genero": "chica", "subcat": "sudaderas", "price": 131673, "img": "item_017.png"}, {"id": 18, "name": "Sudadera Chico 18", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 75512, "img": "item_018.png"}, {"id": 19, "name": "Correa Chico 19", "section": "ropa", "genero": "chico", "subcat": "correas", "price": 104429, "img": "item_019.png"}, {"id": 20, "name": "Libro 20", "section": "libros", "genero": "todos", "subcat": "todos", "price": 40659, "img": "item_020.png"}, {"id": 21, "name": "Libro 21", "section": "libros", "genero": "todos", "subcat": "todos", "price": 53283, "img": "item_021.png"}, {"id": 22, "name": "Sudadera Chico 22", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 124840, "img": "item_022.png"}, {"id": 23, "name": "Camisa Chica 23", "section": "ropa", "genero": "chica", "subcat": "camisas", "price": 105589, "img": "item_023.png"}, {"id": 24, "name": "Libro 24", "section": "libros", "genero": "todos", "subcat": "todos", "price": 47691, "img": "item_024.png"}, {"id": 25, "name": "Sudadera Chico 25", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 75021, "img": "item_025.png"}, {"id": 26, "name": "Zapatos Chico 26", "section": "ropa", "genero": "chico", "subcat": "zapatos", "price": 80093, "img": "item_026.png"}, {"id": 27, "name": "Correa Chica 27", "section": "ropa", "genero": "chica", "subcat": "correas", "price": 72869, "img": "item_027.png"}, {"id": 28, "name": "Libro 28", "section": "libros", "genero": "todos", "subcat": "todos", "price": 55928, "img": "item_028.png"}, {"id": 29, "name": "Libro 29", "section": "libros", "genero": "todos", "subcat": "todos", "price": 39363, "img": "item_029.png"}, {"id": 30, "name": "Libro 30", "section": "libros", "genero": "todos", "subcat": "todos", "price": 39150, "img": "item_030.png"}, {"id": 31, "name": "Zapatos Chico 31", "section": "ropa", "genero": "chico", "subcat": "zapatos", "price": 121484, "img": "item_031.png"}, {"id": 32, "name": "Libro 32", "section": "libros", "genero": "todos", "subcat": "todos", "price": 53723, "img": "item_032.png"}, {"id": 33, "name": "Zapatos Chica 33", "section": "ropa", "genero": "chica", "subcat": "zapatos", "price": 56915, "img": "item_033.png"}, {"id": 34, "name": "Camisa Chica 34", "section": "ropa", "genero": "chica", "subcat": "camisas", "price": 127240, "img": "item_034.png"}, {"id": 35, "name": "Sudadera Chico 35", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 95432, "img": "item_035.png"}, {"id": 36, "name": "Libro 36", "section": "libros", "genero": "todos", "subcat": "todos", "price": 69052, "img": "item_036.png"}, {"id": 37, "name": "Libro 37", "section": "libros", "genero": "todos", "subcat": "todos", "price": 64676, "img": "item_037.png"}, {"id": 38, "name": "Libro 38", "section": "libros", "genero": "todos", "subcat": "todos", "price": 66256, "img": "item_038.png"}, {"id": 39, "name": "Correa Chica 39", "section": "ropa", "genero": "chica", "subcat": "correas", "price": 145741, "img": "item_039.png"}, {"id": 40, "name": "Libro 40", "section": "libros", "genero": "todos", "subcat": "todos", "price": 37310, "img": "item_040.png"}, {"id": 41, "name": "Libro 41", "section": "libros", "genero": "todos", "subcat": "todos", "price": 58492, "img": "item_041.png"}, {"id": 42, "name": "Sudadera Chico 42", "section": "ropa", "genero": "chico", "subcat": "sudaderas", "price": 139646, "img": "item_042.png"}, {"id": 43, "name": "Libro 43", "section": "libros", "genero": "todos", "subcat": "todos", "price": 62806, "img": "item_043.png"}, {"id": 44, "name": "Correa Chica 44", "section": "ropa", "genero": "chica", "subcat": "correas", "price": 128748, "img": "item_044.png"}, {"id": 45, "name": "Correa Chica 45", "section": "ropa", "genero": "chica", "subcat": "correas", "price": 144943, "img": "item_045.png"}, {"id": 46, "name": "Correa Chica 46", "section": "ropa", "genero": "chica", "subcat": "correas", "price": 109042, "img": "item_046.png"}, {"id": 47, "name": "Correa Chica 47", "section": "ropa", "genero": "chica", "subcat": "correas", "price": 85306, "img": "item_047.png"}, {"id": 48, "name": "Camisa Chica 48", "section": "ropa", "genero": "chica", "subcat": "camisas", "price": 119364, "img": "item_048.png"}, {"id": 49, "name": "Zapatos Chica 49", "section": "ropa", "genero": "chica", "subcat": "zapatos", "price": 54071, "img": "item_049.png"}, {"id": 50, "name": "Zapatos Chica 50", "section": "ropa", "genero": "chica", "subcat": "zapatos", "price": 117063, "img": "item_050.png"}];
  function renderInv(){
    const body = document.getElementById('invBody');
    const ov = getOverrides();
    const vis = getVisibility();
    
    const fSec = document.getElementById('fSeccion').value;
    const fGen = document.getElementById('fGenero').value;
    const fSub = document.getElementById('fSub').value;
    const q = (document.getElementById('fSearch').value || '').trim().toLowerCase();

    const filtered = BASE_ITEMS.filter(it => {
      const okSec = (fSec==='todos' || it.section===fSec);
      const okGen = (fSec!=='ropa' || fGen==='todos' || it.genero===fGen);
      const okSub = (fSec!=='ropa' || fSub==='todos' || it.subcat===fSub);
      const okQ = (!q || (it.name||'').toLowerCase().includes(q));
      return okSec && okGen && okSub && okQ;
    });

    body.innerHTML = filtered.map(it => {
      const price = (ov[it.name] && typeof ov[it.name].price==='number') ? ov[it.name].price : it.price;
      const visible = vis[it.name] !== false;
      const stock = getStock();
      return `
        <tr data-l1="${it.section}" data-genero="${it.genero}" data-sub="${it.subcat}" data-name="${it.name}">
          <td><img src="${it.img && it.img.startsWith('data:') ? it.img : 'img/'+it.img}" class="inv-thumb" alt=""></td>
          <td>${it.name}</td>
          <td>${it.section}</td>
          <td>${it.genero}</td>
          <td>${it.subcat}</td>
          <td><input type="number" type="text" inputmode="numeric" pattern="[0-9]*" class="form-control form-control-sm stock-input w-110" data-name="${it.name}" value="${stock[it.name] ?? 0}" min="0"></td>
          <td><input type="number" type="text" inputmode="numeric" pattern="[0-9]*" class="form-control form-control-sm price-input w-110" data-name="${it.name}" value="${price}" min="0" ${isAdmin()?'':'disabled'}></td>
          <td>
            <div class="form-check form-switch">
              <input class="form-check-input visible-toggle" type="checkbox" data-name="${it.name}" ${visible?'checked':''}>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
  }

  document.getElementById('saveInvBtn').addEventListener('click', ()=>{
    const prices = document.querySelectorAll('.price-input');
    const visToggles = document.querySelectorAll('.visible-toggle');
    const ov = getOverrides(); const vis = getVisibility();
    prices.forEach(inp => {
      const name = inp.dataset.name; const val = parseInt(inp.value||'0',10);
      ov[name] = ov[name] || {}; ov[name].price = val;
    });
    visToggles.forEach(sw => {
      const name = sw.dataset.name; vis[name] = sw.checked;
    });
    saveOverrides(ov); saveVisibility(vis);
    alert('Cambios guardados. Ve al catálogo para ver el efecto.');
  });

  document.getElementById('resetInvBtn').addEventListener('click', ()=>{
    localStorage.removeItem('overrides');
    localStorage.removeItem('visibility');
    renderInv();
  ['fSeccion','fGenero','fSub','fSearch'].forEach(id=>document.getElementById(id).addEventListener('input', renderInv));
  });

  renderOrders();
  renderReservas();
  renderInv();
  ['fSeccion','fGenero','fSub','fSearch'].forEach(id=>document.getElementById(id).addEventListener('input', renderInv));
</script>
</body>
</html>
